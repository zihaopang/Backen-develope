# 一、概述
端系统H1中的网络层取得来自H1运输层的报文段，将该报文段封装成一个数据报（网络层分组），然后将数据报向相邻路由器R1发送。在接收方H2，网络层接收来自路由器的数据报，从中提取运输层报文段，并交给H2的运输层。

### 1、转发和路由选择
- 转发：当一个分组到达路由器的一条输出链路的时候，路由器必须将该分组移动到适当的输出链路。
- 路由选择：当分组从发送方流向接收方的时候，网络层必须决定这些分组所采用的路由或路径。计算路径的方法为**路由选择算法**。如下图所示

</br>![路由选择算法决定转发表中的值](http://)</br>

### 2、网络服务模型
网络服务模型定义了分组在发送端和接收端之间的端到端与运输特性

- 确保交付
- 具有时延上界的确保交付
- 有序分组交付
- 确保最小带宽：只要发送主机低于特定比特传输，则分组 不会丢失
- 确保最大时延抖动：发送方发送两个分组的时间间隔约等于接收方接收到这两个分组的时间间隔，或者说这两组间隔时间不超过特定值
- 安全性服务

因特网的网络层提供了单一的服务，称为**尽力而为服务**，传输的分组不易i的那个能保证最终交付，然而，这种极为简化的模型是有必要存在的。

# 二、虚电路和数据报电路
- 仅在网络层提供连接服务的计算机网络称为**虚电路**，仅在网络层提供无连接服务的计算机网络称为**数据报网络**。
- 运输层的连接服务是在位于网络边缘的端系统中实现的。二网络层连接服务除了在端系统，还在路由器中实现

### 1、虚电路网络
一条虚电路的组成如下：
- 源和目的主机之间的路径
- VC号
- 沿着该路径每条路由器中的转发表表项

下图中，假定主机A请求该网络在他自己与主机B之间创建一条虚电路，同时路径选择为：A-R1-R2-B，并为这条路径上的三条链路分配VC号：12，22，32.在该分组离开主机A时，在该分组首部中VC字段的数值是12，当它离开R1时候，该数值是22，离开R2时候，该数值是32.

</br>![一个简单的虚电路网络](http://)</br>

该网络的路由器必须为进行中的连接维持**连接状态信息**。特别是，每当跨越一条路由器时候，转发表需要新建一个连接项。每当释放一个连接，必须删除该项。值得注意的是，即使没有VC号转换，仍有必要维持连接状态信息。

在虚电路中有3个明显不同的阶段：
- 虚电路建立
- 数据传送
- 虚电路拆除

对于一个虚电路网络层，沿两个端系统之间路径上的路由器都要参与虚电路建立，并且每台路由器都知道所有经过他的虚电路。

### 2、数据报网络
在**数据报网络**中，每当端系统要发送一个分组，他就为该分组加上目的端系统的地址，然后将分组推进网络中。
路由器通过分组的目的地址来转发分组，但目的地地址有32个比特，这种选择完全不可能。下面举个例子。
假设路由器右四条链路，编号0~3，如下图所示：
</br>![路由选择算法决定转发表中的值](http://)</br>
对于这个例子，不需要49个表项，只需要4个表项：
</br>![4个表项](http://)</br>
使用这种风格的转发表，路由器用分组的目的地址的**前缀**与该表项进行匹配；如果存在一个匹配项，则转发分组。如果有多个匹配项，使用**最长前缀匹配规则**，即寻找该表中最长的匹配项。

### 3、虚电路和数据报网络的由来
虚电路的概念来源于电话界，他采用了真正的电路。而因特网作为一种数据报网络，是由将计算机连接在一起的需求发展起来的。

# 三、路由器工作原理
</br>![路由器的体系结构](http://)</br>
分别包括：输入端口、交换结构、输出端口、路由选择处理器。
一台路由器的输入端口，输出端口和交换结构共同实现了转发共嫩恶搞。这种转发功能有时总称为**路由器转发平面**。
### 1、输入端口
</br>![输入端口处理](http://)</br>
假定转发表已经存在，从概念上将查找是简单的，即总是搜索转发表查找最长的前缀匹配。但是在吉比特速率下，这种查找必须在纳秒级查找完成。所以在路由器中，一般使用DRAM和更快速的SRAM内存来设计。
分组通过端口，就能进入交换结构，但如果其他分组正在使用交换结构，该分组可能被暂时阻塞。
### 2、交换结构
</br>![三种交换结构](http://)</br>
- 内存交换：在CPU控制下直接完成
- 总线交换：通过一根共享总线将分组直接送到输出端口。做法通常是让分组计划一个内部标签，只是输出端口，然后到达输出端口后去除该标签。
- 互联网络交换：克服单一总线带宽的限制，称为纵横交换机。

### 3、输出端口
</br>![输出端口处理](http://)</br>

### 4、何处出现排队
既定输入线路的速度和输出线路的速度是相同的，均为每秒R1个分组。定义交换速度R2为从输入端口到输出端口移动分组的速率。如果R2比R1快N倍（N为输入端口数），那么在输入端口没有问题。但如果这些分组都转发到一号输出端口，那么输出端口就会阻塞。情况如下图所示：
</br>![输出端口的竞争](http://)</br>
那么一个自然而然地问题就是需要多少缓存？缓存数量应该等于平均往返时延乘以链路的容量.
输出端排队或者说阻塞的后果就是在端口上要运行一个**分组调度程序**，可以是先来先，先可是优先级。
类似的，如果没有足够的缓存，那么必须做决定丢弃一个（**弃尾**）或者多个分组。这些策略统称为**主动队列管理(Active Queue Management,AQM)**
</br>
还有种算法叫做**随机早期检测(Random early Detection,RED)**,RED是一种广泛应用的AQM算法，在RED中，为输出队列长度维护者一个加权平均值。如果分组到达，发现平均队列长度小于最小阈值MIN，则加入队列。如果发现平均队列长度大于最大值MAX，则丢弃，如果在[MIN,MAX]之间，则一定概率丢弃。
</br>
当输出端口的队列满时，那么输入端口就会发生阻塞，这种现象叫做**线路前部阻塞**。

# 四、网际协议：因特网中的转发和编址



